<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ÎåÄÎ¶¨Ï†ê Î∞©Î¨∏ ÏßÄÎèÑ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=k8vacdhpym&submodules=geocoder"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<!-- SheetJS for Excel -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100vw; height:100vh; }

#progress {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
}

#download-btn {
  position:absolute;
  top:50px;
  right:10px;
  z-index:1000;
  background:#4caf50;
  color:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
  cursor:pointer;
  border:none;
  font-size:14px;
  transition:.2s;
}

#download-btn:hover {
  background:#45a049;
}

#loading {
  position:absolute;
  top:95px;
  right:10px;
  z-index:1000;
  background:#2196f3;
  color:#fff;
  padding:8px 12px;
  border-radius:16px;
  font-size:12px;
  display:none;
}

/* ÎßêÌíçÏÑ† */
.bubble {
  position:relative;
  background:#fff;
  border:2px solid #d32f2f;
  border-radius:8px;
  padding:4px 10px;
  font-size:12px;
  font-weight:bold;
  white-space:nowrap;
  cursor:pointer;
  transition:.2s;
}

.bubble.visited {
  border-color:#1976d2;
  background-color:#e3f2fd;
  color:#1976d2;
}

.bubble:after {
  content:"";
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:-8px;
  width:0;
  height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-top:8px solid #d32f2f;
}

.bubble.visited:after {
  border-top-color:#1976d2;
}

/* Î™®Îã¨ */
#modal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  z-index:2000;
  justify-content:center;
  align-items:center;
}

#modal.show {
  display:flex;
}

#modal-content {
  background:#fff;
  border-radius:12px;
  padding:24px;
  width:90%;
  max-width:400px;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}

#modal-title {
  font-size:18px;
  font-weight:bold;
  margin-bottom:16px;
  color:#333;
}

.modal-section {
  margin-bottom:16px;
}

.modal-section label {
  display:block;
  font-weight:bold;
  margin-bottom:8px;
  color:#555;
}

.status-buttons {
  display:flex;
  gap:8px;
}

.status-btn {
  flex:1;
  padding:10px;
  border:2px solid #ddd;
  background:#fff;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  transition:.2s;
}

.status-btn:hover {
  background:#f5f5f5;
}

.status-btn.active.visited {
  border-color:#1976d2;
  background:#1976d2;
  color:#fff;
}

.status-btn.active.not-visited {
  border-color:#d32f2f;
  background:#d32f2f;
  color:#fff;
}

#comment-input {
  width:100%;
  min-height:100px;
  padding:10px;
  border:2px solid #ddd;
  border-radius:8px;
  font-size:14px;
  resize:vertical;
  box-sizing:border-box;
  font-family:inherit;
}

#char-count {
  text-align:right;
  font-size:12px;
  color:#666;
  margin-top:4px;
}

.modal-buttons {
  display:flex;
  gap:8px;
  margin-top:20px;
}

.modal-btn {
  flex:1;
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  font-size:14px;
  transition:.2s;
}

.modal-btn.save {
  background:#4caf50;
  color:#fff;
}

.modal-btn.save:hover {
  background:#45a049;
}

.modal-btn.cancel {
  background:#f5f5f5;
  color:#333;
}

.modal-btn.cancel:hover {
  background:#e0e0e0;
}
</style>
</head>

<body>

<div id="progress">ÏôÑÎ£åÏú® 0%</div>
<button id="download-btn">üì• ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú</button>
<div id="loading">Ï†ÄÏû• Ï§ë...</div>
<div id="map"></div>

<!-- Î™®Îã¨ -->
<div id="modal">
  <div id="modal-content">
    <div id="modal-title"></div>
    
    <div class="modal-section">
      <label>Î∞©Î¨∏ ÏÉÅÌÉú</label>
      <div class="status-buttons">
        <button class="status-btn not-visited" data-status="false">ÎØ∏Î∞©Î¨∏</button>
        <button class="status-btn visited" data-status="true">Î∞©Î¨∏ÏôÑÎ£å</button>
      </div>
    </div>
    
    <div class="modal-section">
      <label>ÏΩîÎ©òÌä∏ (500Ïûê Ïù¥ÎÇ¥)</label>
      <textarea id="comment-input" maxlength="500" placeholder="Î∞©Î¨∏ ÌõÑÍ∏∞ÎÇò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî..."></textarea>
      <div id="char-count">0/500</div>
    </div>
    
    <div class="modal-buttons">
      <button class="modal-btn cancel">Ï∑®ÏÜå</button>
      <button class="modal-btn save">Ï†ÄÏû•</button>
    </div>
  </div>
</div>

<script>
// ============================================
// Firebase ÏÑ§Ï†ï
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyDjTcHpGJskJNkY-qLlU02A_yDe4fCZIaI",
  authDomain: "store-map-5cf8b.firebaseapp.com",
  projectId: "store-map-5cf8b",
  storageBucket: "store-map-5cf8b.firebasestorage.app",
  messagingSenderId: "805186031186",
  appId: "1:805186031186:web:694602e04ee9579189998b"
};

// Firebase Ï¥àÍ∏∞Ìôî
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ============================================
// Îß§Ïû• Îç∞Ïù¥ÌÑ∞
// ============================================
const stores = [
{num:1,name:"Ïã†ÎèÑSDR",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ ÌÖåÌó§ÎûÄÎ°ú88Í∏∏ 14"},
{num:2,name:"ÌÅ∞ÏÇ¨ÎûëÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ Ïñ∏Ï£ºÎ°ú30Í∏∏ 21"},
{num:3,name:"ÌïúÏú†ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ Í¥ëÌèâÎ°ú51Í∏∏ 8"},
{num:4,name:"ÏÉàÏÑúÏö∏ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ ÏïïÍµ¨Ï†ïÎ°ú 154"},
{num:5,name:"Í∞ïÎÇ®Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ ÏÑ†Î¶âÎ°ú 640"},
{num:6,name:"Í∞ïÎÇ®Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ ÏùºÏõêÎ°ú 41"},
{num:7,name:"Í∞ïÎÇ®Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ ÏÑ†Î¶âÎ°ú 640"},
{num:8,name:"ÎùºÏù¥Ï¶à",address:"ÏÑúÏö∏ Í∞ïÎÇ®Íµ¨ ÎÖºÌòÑÎ°ú154Í∏∏ 16"},
{num:9,name:"Ïò§ÏïÑÏãúÏä§",address:"ÏÑúÏö∏ Í∞ïÎèôÍµ¨ Ï≤úÌò∏ÏòõÍ∏∏ 70"},
{num:10,name:"Ï§ÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎèôÍµ¨ Ï≤úÌò∏ÎåÄÎ°ú 1099"},
{num:11,name:"Ìä∏Î†åÎìúÌîåÎûòÎÑà",address:"ÏÑúÏö∏ Í∞ïÎèôÍµ¨ Ï≤úÌò∏ÏòõÍ∏∏ 70"},
{num:12,name:"ÏÑúÏö∏entÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎèôÍµ¨ Í∞ïÎèôÎåÄÎ°ú53Í∏∏ 31"},
{num:13,name:"ÏÑúÏö∏entÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎèôÍµ¨ Í∞ïÎèôÎåÄÎ°ú53Í∏∏ 31"},
{num:14,name:"ÏïÑÎ¶¨Ïò®",address:"ÏÑúÏö∏ Í∞ïÎèôÍµ¨ ÏÉÅÏïîÎ°ú 47"},
{num:15,name:"ÎäòÎ¥ÑÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÎèôÍµ¨ ÏÑ±ÎÇ¥Î°ú 6"},
{num:16,name:"ÌîºÏï§Ïî®ÌôÄÎî©Ïä§",address:"ÏÑúÏö∏ Í∞ïÎ∂ÅÍµ¨ ÏÇºÏñëÎ°ú 237"},
{num:17,name:"PS&M",address:"ÏÑúÏö∏ Í∞ïÎ∂ÅÍµ¨ ÎèÑÎ¥âÎ°ú 353"},
{num:18,name:"Ïã†ÎÇòÎäî",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í≥µÌï≠ÎåÄÎ°ú 168"},
{num:19,name:"Ï∞∏Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÏñëÏ≤úÎ°ú 583"},
{num:20,name:"ÎèÑÏùºÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÏñëÏ≤úÎ°ú 556"},
{num:21,name:"ÏóºÏ∞ΩÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÏñëÏ≤úÎ°ú 706"},
{num:22,name:"ÏÉÅÎ°ùÏàòÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú 254"},
{num:23,name:"ÏÉÅÎ°ùÏàòÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú 242"},
{num:24,name:"Î∞±ÎëêÎåÄÍ∞ÑÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÏñëÏ≤úÎ°ú 86"},
{num:25,name:"ÎèôÏßÑÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ Í∞ïÏÑúÎ°ú 279"},
{num:26,name:"Ïó∞Ïö∞ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∞ïÏÑúÍµ¨ ÏõîÏ†ïÎ°ú 160"},
{num:27,name:"Ï†ïÏõêÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ Íµ¨ÏùòÍ∞ïÎ≥ÄÎ°ú 64"},
{num:28,name:"CDÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ Ï≤úÌò∏ÎåÄÎ°ú 597"},
{num:29,name:"Í¥ëÏû•ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ Î©¥Î™©Î°ú 160"},
{num:30,name:"Ïö∏Î¶ºÌÑ∞ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ ÏïÑÏ∞®ÏÇ∞Î°ú 220"},
{num:31,name:"ÏïåÎ¶¨Î∞îÎ∞îÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ Ï≤úÌò∏ÎåÄÎ°ú143Í∏∏ 23"},
{num:32,name:"ÏïÑÌÜ†",address:"ÏÑúÏö∏ Í¥ëÏßÑÍµ¨ Ï≤úÌò∏ÎåÄÎ°ú 571"},
{num:33,name:"CDÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Íµ¨Î°úÍµ¨ Í≤ΩÏù∏Î°ú 661"},
{num:34,name:"Íµ¨Î°úÏÑúÎ∂ÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Íµ¨Î°úÍµ¨ Íµ¨Î°úÎèôÎ°ú 82"},
{num:35,name:"PS&M",address:"ÏÑúÏö∏ Íµ¨Î°úÍµ¨ Í≤ΩÏù∏Î°ú 661"},
{num:36,name:"PS&M",address:"ÏÑúÏö∏ Íµ¨Î°úÍµ¨ ÎèÑÎ¶ºÎ°ú 73"},
{num:37,name:"ÎèÖÏÇ∞ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∏àÏ≤úÍµ¨ ÏãúÌù•ÎåÄÎ°ú 233"},
{num:38,name:"Ïñ¥ÌîÑÎ†àÏâ¨ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∏àÏ≤úÍµ¨ ÏãúÌù•ÎåÄÎ°ú138Í∏∏ 19"},
{num:39,name:"ÏßÄÏùÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Í∏àÏ≤úÍµ¨ Î≤öÍΩÉÎ°ú 234"},
{num:40,name:"ÏÑúÏö∏entÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÌïúÍ∏ÄÎπÑÏÑùÎ°ú 384"},
{num:41,name:"ÏïåÌååÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÎÖ∏ÏõêÍµ¨ ÏÑùÍ≥ÑÎ°ú 4"},
{num:42,name:"Ïã†Ï∞ΩÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÎèÑÎ¥âÍµ¨ ÎçïÎ¶âÎ°ú 248-1"},
{num:43,name:"ÏÑúÏö∏Ïã†ÎãπÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÎèôÎåÄÎ¨∏Íµ¨ Ï≤úÌò∏ÎåÄÎ°ú 14"},
{num:44,name:"707",address:"ÏÑúÏö∏ ÎßàÌè¨Íµ¨ ÏõîÎìúÏªµÎ°ú 62"},
{num:45,name:"Ïö∏Î¶ºÌÑ∞ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÎßàÌè¨Íµ¨ ÏñëÌôîÎ°ú 45"},
{num:46,name:"Ìì®Ï≤òÏä§",address:"ÏÑúÏö∏ ÎßàÌè¨Íµ¨ Î™®ÎûòÎÇ¥Î°ú 5"},
{num:47,name:"ÎÖºÌòÑÏó≠ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏÑúÏ¥àÍµ¨ ÏÇ¨ÌèâÎåÄÎ°ú55Í∏∏ 149"},
{num:48,name:"ÎØ∏ÎûòÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏÑ±ÎèôÍµ¨ ÎßàÏû•Î°ú 284-1"},
{num:49,name:"ÌïúÏú†ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏÑ±ÎèôÍµ¨ ÏïÑÏ∞®ÏÇ∞Î°ú 33"},
{num:50,name:"SKÎ™®Î∞îÏùºÌè¨ÌÉà",address:"ÏÑúÏö∏ ÏÑ±ÎèôÍµ¨ ÏïÑÏ∞®ÏÇ∞Î°ú 38"},
{num:51,name:"ÎäòÌë∏Î•∏ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏÑ±Î∂ÅÍµ¨ ÎèôÏÜåÎ¨∏Î°ú 17"},
{num:52,name:"Ï†ïÎ¶âÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏÑ±Î∂ÅÍµ¨ Î≥¥Íµ≠Î¨∏Î°ú 81"},
{num:53,name:"ÏïåÌååÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏÑ±Î∂ÅÍµ¨ Í∏∏ÏùåÎ°ú 33"},
{num:54,name:"ACEÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏÑ±Î∂ÅÍµ¨ ÌôîÎûëÎ°ú 248"},
{num:55,name:"PS&M",address:"ÏÑúÏö∏ ÏÑ±Î∂ÅÍµ¨ ÏïÑÎ¶¨ÎûëÎ°ú 10"},
{num:56,name:"Î∏åÎ†àÏù∏ÏïÑÏù¥Ïî®Ìã∞",address:"ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Î≤ïÏõêÎ°ú11Í∏∏ 11"},
{num:57,name:"ÏóêÏä§Ïïå",address:"ÏÑúÏö∏ ÏÜ°ÌååÍµ¨ Î≤ïÏõêÎ°ú8Í∏∏ 7"},
{num:58,name:"Ï∞∏Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ ÎÇ®Î∂ÄÏàúÌôòÎ°ú 585"},
{num:59,name:"ÌïúÏú†ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÎèôÎ°ú 379"},
{num:60,name:"ÏóêÏä§Ïïå",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ ÏßÄÏñëÎ°ú 74"},
{num:61,name:"Î∞±ÎëêÎåÄÍ∞ÑÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏñëÏ≤úÍµ¨ Î™©ÎèôÏÑúÎ°ú 349"},
{num:62,name:"ÏÑúÏö∏entÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏòÅÎì±Ìè¨Íµ¨ ÎèÑÏòÅÎ°ú 27"},
{num:63,name:"Ïú†ÌÜµÏÉÅÍ∞ÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏòÅÎì±Ìè¨Íµ¨ ÏòÅÎì±Ìè¨Î°ú 131"},
{num:64,name:"Ïú†ÏõêÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏòÅÎì±Ìè¨Íµ¨ ÏÑ†Ïú†Î°ú49Í∏∏ 23"},
{num:65,name:"ÏÉàÏÉòÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏòÅÎì±Ìè¨Íµ¨ ÎãπÏÇ∞Î°ú 83"},
{num:66,name:"ÌéúÌÉÄÍ≥§",address:"ÏÑúÏö∏ Ïö©ÏÇ∞Íµ¨ ÌïúÍ∞ïÎåÄÎ°ú7Í∏∏ 10-8"},
{num:67,name:"ÌîÑÎ¶¨Ïä§ÎπÑ",address:"ÏÑúÏö∏ Ïö©ÏÇ∞Íµ¨ ÌïúÍ∞ïÎåÄÎ°ú 283-8"},
{num:68,name:"ÌîºÏï§Ïî®ÌôÄÎî©Ïä§",address:"ÏÑúÏö∏ Ïö©ÏÇ∞Íµ¨ Ïù¥ÌÉúÏõêÎ°ú 187"},
{num:69,name:"ÌïúÏú†ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏùÄÌèâÍµ¨ Ïó∞ÏÑúÎ°ú 75"},
{num:70,name:"Î≤îÍµêÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏùÄÌèâÍµ¨ ÏàòÏÉâÎ°ú 195"},
{num:71,name:"Ïã†ÎìúÎ°¨ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ ÏùÄÌèâÍµ¨ ÏÑúÏò§Î¶âÎ°ú 173"},
{num:72,name:"Ï∞∏Ïä§ÌÉÄÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Ï¢ÖÎ°úÍµ¨ ÏÜ°ÏõîÍ∏∏ 99"},
{num:73,name:"Ïú†ÎãàÏø±ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Ï¢ÖÎ°úÍµ¨ ÏÑ±Í∑†Í¥ÄÎ°ú 15"},
{num:74,name:"Ïú†ÏÑ†ÎåÄÎ¶¨Ï†ê",address:"ÏÑúÏö∏ Ï§ëÍµ¨ Îã§ÏÇ∞Î°ú 132"},
{num:75,name:"ÌîÑÎ¶¨Ïä§ÎπÑ",address:"ÏÑúÏö∏ Ï§ëÍµ¨ ÎèôÌò∏Î°ú 180"},
{num:76,name:"Orange",address:"ÏÑúÏö∏ Ï§ëÍµ¨ Î™ÖÎèô3Í∏∏ 6"},
{num:77,name:"ÌîºÏï§Ïî®ÌôÄÎî©Ïä§",address:"ÏÑúÏö∏ Ï§ëÎûëÍµ¨ Ïö©ÎßàÏÇ∞Î°ú115Í∏∏ 127"},
{num:78,name:"PS&M",address:"ÏÑúÏö∏ Ï§ëÎûëÍµ¨ ÎèôÏùºÎ°ú 801"}
];

let storeData = {};
let currentStore = null;
let map;

// ============================================
// Firebase Ìï®ÏàòÎì§
// ============================================

// FirestoreÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞
async function loadDataFromFirebase() {
  try {
    const snapshot = await db.collection('stores').get();
    snapshot.forEach(doc => {
      storeData[doc.id] = doc.data();
    });
    console.log('FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î°úÎìú ÏôÑÎ£å:', Object.keys(storeData).length + 'Í∞ú');
    updateAllBubbles();
    updateProgress();
  } catch (error) {
    console.error('Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®:', error);
  }
}

// FirestoreÏóê Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•ÌïòÍ∏∞
async function saveDataToFirebase(storeNum, data) {
  showLoading(true);
  try {
    await db.collection('stores').doc(String(storeNum)).set(data);
    console.log(`Îß§Ïû• ${storeNum} Ï†ÄÏû• ÏôÑÎ£å`);
    showLoading(false);
  } catch (error) {
    console.error('Ï†ÄÏû• Ïã§Ìå®:', error);
    alert('Ï†ÄÏû•Ïóê Ïã§Ìå®ÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
    showLoading(false);
  }
}

// Î°úÎî© ÌëúÏãú
function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// Î™®Îì† ÎßêÌíçÏÑ† ÏóÖÎç∞Ïù¥Ìä∏
function updateAllBubbles() {
  Object.keys(storeData).forEach(num => {
    const bubble = document.getElementById(`b-${num}`);
    if (bubble && storeData[num].visited) {
      bubble.classList.add('visited');
    }
  });
}

// ============================================
// ÏóëÏÖÄ Îã§Ïö¥Î°úÎìú Í∏∞Îä•
// ============================================

function downloadExcel() {
  // ÏóëÏÖÄ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
  const excelData = [];
  
  // Ìó§Îçî Ï∂îÍ∞Ä
  excelData.push(['ÎÑòÎ≤Ñ', 'ÎåÄÎ¶¨Ï†ê Ïù¥Î¶Ñ', 'ÎåÄÎ¶¨Ï†ê Ï£ºÏÜå', 'ÏôÑÎ£å Ïó¨Î∂Ä', 'ÏΩîÎ©òÌä∏']);
  
  // Í∞Å Îß§Ïû• Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
  stores.forEach(store => {
    const data = storeData[store.num] || {visited: false, comment: ""};
    excelData.push([
      store.num,
      store.name,
      store.address,
      data.visited ? 'ÏôÑÎ£å' : 'ÎØ∏Î∞©Î¨∏',
      data.comment || ''
    ]);
  });
  
  // ÏõåÌÅ¨ÏãúÌä∏ ÏÉùÏÑ±
  const ws = XLSX.utils.aoa_to_sheet(excelData);
  
  // Ïó¥ ÎÑàÎπÑ ÏÑ§Ï†ï
  ws['!cols'] = [
    {wch: 8},   // AÏó¥: ÎÑòÎ≤Ñ
    {wch: 25},  // BÏó¥: ÎåÄÎ¶¨Ï†ê Ïù¥Î¶Ñ
    {wch: 35},  // CÏó¥: ÎåÄÎ¶¨Ï†ê Ï£ºÏÜå
    {wch: 12},  // DÏó¥: ÏôÑÎ£å Ïó¨Î∂Ä
    {wch: 50}   // EÏó¥: ÏΩîÎ©òÌä∏
  ];
  
  // ÏõåÌÅ¨Î∂Å ÏÉùÏÑ±
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'ÎåÄÎ¶¨Ï†ê Î∞©Î¨∏ ÌòÑÌô©');
  
  // ÌååÏùºÎ™Ö ÏÉùÏÑ± (ÌòÑÏû¨ ÎÇ†Ïßú Ìè¨Ìï®)
  const today = new Date();
  const dateStr = `${today.getFullYear()}${String(today.getMonth()+1).padStart(2,'0')}${String(today.getDate()).padStart(2,'0')}`;
  const filename = `ÎåÄÎ¶¨Ï†ê_Î∞©Î¨∏ÌòÑÌô©_${dateStr}.xlsx`;
  
  // Îã§Ïö¥Î°úÎìú
  XLSX.writeFile(wb, filename);
}

// Îã§Ïö¥Î°úÎìú Î≤ÑÌäº Ïù¥Î≤§Ìä∏
document.getElementById('download-btn').addEventListener('click', downloadExcel);

// ============================================
// Í∏∞Ï°¥ Ìï®ÏàòÎì§
// ============================================

function updateProgress(){
  const total = stores.length;
  const done = Object.values(storeData).filter(v=>v.visited).length;
  const percent = Math.round((done/total)*100);
  document.getElementById("progress").innerText =
    `ÏôÑÎ£åÏú® ${done}/${total} (${percent}%)`;
}

function openModal(storeNum){
  currentStore = storeNum;
  const store = stores.find(s => s.num === storeNum);
  const data = storeData[storeNum] || {visited: false, comment: ""};
  
  document.getElementById("modal-title").innerText = 
    `${store.num}. ${store.name}`;
  
  document.querySelectorAll(".status-btn").forEach(btn => {
    btn.classList.remove("active");
    if(btn.dataset.status === String(data.visited)){
      btn.classList.add("active");
    }
  });
  
  const textarea = document.getElementById("comment-input");
  textarea.value = data.comment || "";
  updateCharCount();
  
  document.getElementById("modal").classList.add("show");
}

function closeModal(){
  document.getElementById("modal").classList.remove("show");
  currentStore = null;
}

async function saveModal(){
  const visitedBtn = document.querySelector(".status-btn.active");
  const visited = visitedBtn ? visitedBtn.dataset.status === "true" : false;
  const comment = document.getElementById("comment-input").value;
  
  const data = {visited, comment, updatedAt: new Date().toISOString()};
  storeData[currentStore] = data;
  
  // FirebaseÏóê Ï†ÄÏû•
  await saveDataToFirebase(currentStore, data);
  
  // ÎßêÌíçÏÑ† Ïä§ÌÉÄÏùº ÏóÖÎç∞Ïù¥Ìä∏
  const bubble = document.getElementById(`b-${currentStore}`);
  if(visited){
    bubble.classList.add("visited");
  } else {
    bubble.classList.remove("visited");
  }
  
  updateProgress();
  closeModal();
}

function updateCharCount(){
  const textarea = document.getElementById("comment-input");
  const count = textarea.value.length;
  document.getElementById("char-count").innerText = `${count}/500`;
}

// Î™®Îã¨ Ïù¥Î≤§Ìä∏
document.querySelector(".modal-btn.cancel").addEventListener("click", closeModal);
document.querySelector(".modal-btn.save").addEventListener("click", saveModal);
document.getElementById("comment-input").addEventListener("input", updateCharCount);

document.querySelectorAll(".status-btn").forEach(btn => {
  btn.addEventListener("click", function(){
    document.querySelectorAll(".status-btn").forEach(b => b.classList.remove("active"));
    this.classList.add("active");
  });
});

document.getElementById("modal").addEventListener("click", function(e){
  if(e.target === this){
    closeModal();
  }
});

// ============================================
// ÏßÄÎèÑ Ï¥àÍ∏∞Ìôî
// ============================================

naver.maps.onJSContentLoaded = async function(){
  // FirebaseÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Î®ºÏ†Ä Î∂àÎü¨Ïò§Í∏∞
  await loadDataFromFirebase();
  
  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.55,126.97),
    zoom: 11
  });

  const bounds = new naver.maps.LatLngBounds();

  stores.forEach((store,index)=>{
    // Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ÏÑ§Ï†ï (FirebaseÏóê ÏóÜÏúºÎ©¥)
    if (!storeData[store.num]) {
      storeData[store.num] = {visited: false, comment: ""};
    }

    setTimeout(()=>{
      naver.maps.Service.geocode(
        {query:store.address},
        function(status,res){
          if(status !== naver.maps.Service.Status.OK) return;

          const addr = res.v2.addresses[0];
          const pos = new naver.maps.LatLng(addr.y, addr.x);
          bounds.extend(pos);

          const isVisited = storeData[store.num].visited ? 'visited' : '';

          const marker = new naver.maps.Marker({
            position: pos,
            map: map,
            icon:{
              content:`
                <div class="bubble ${isVisited}" id="b-${store.num}">
                  ${store.num}. ${store.name}
                </div>
              `,
              anchor: new naver.maps.Point(50,40)
            }
          });

          naver.maps.Event.addListener(marker,"click",()=>{
            openModal(store.num);
          });

          if(index === stores.length-1){
            map.fitBounds(bounds);
            updateProgress();
          }
        }
      );
    }, index*40);

  });
};
</script>

</body>
</html>
