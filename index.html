<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>대리점 방문 지도</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=k8vacdhpym&submodules=geocoder"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
html, body { margin:0; padding:0; height:100%; }
#map { width:100vw; height:100vh; }

#progress {
  position:absolute;
  top:10px;
  right:10px;
  z-index:1000;
  background:#fff;
  padding:10px 16px;
  border-radius:20px;
  font-weight:bold;
  box-shadow:0 2px 8px rgba(0,0,0,.2);
}

#loading {
  position:absolute;
  top:50px;
  right:10px;
  z-index:1000;
  background:#4caf50;
  color:#fff;
  padding:8px 12px;
  border-radius:16px;
  font-size:12px;
  display:none;
}

/* 말풍선 */
.bubble {
  position:relative;
  background:#fff;
  border:2px solid #d32f2f;
  border-radius:8px;
  padding:4px 10px;
  font-size:12px;
  font-weight:bold;
  white-space:nowrap;
  cursor:pointer;
  transition:.2s;
}

.bubble.visited {
  border-color:#1976d2;
  background-color:#e3f2fd;
  color:#1976d2;
}

.bubble:after {
  content:"";
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:-8px;
  width:0;
  height:0;
  border-left:6px solid transparent;
  border-right:6px solid transparent;
  border-top:8px solid #d32f2f;
}

.bubble.visited:after {
  border-top-color:#1976d2;
}

/* 모달 */
#modal {
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.5);
  z-index:2000;
  justify-content:center;
  align-items:center;
}

#modal.show {
  display:flex;
}

#modal-content {
  background:#fff;
  border-radius:12px;
  padding:24px;
  width:90%;
  max-width:400px;
  box-shadow:0 4px 20px rgba(0,0,0,.3);
}

#modal-title {
  font-size:18px;
  font-weight:bold;
  margin-bottom:16px;
  color:#333;
}

.modal-section {
  margin-bottom:16px;
}

.modal-section label {
  display:block;
  font-weight:bold;
  margin-bottom:8px;
  color:#555;
}

.status-buttons {
  display:flex;
  gap:8px;
}

.status-btn {
  flex:1;
  padding:10px;
  border:2px solid #ddd;
  background:#fff;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  transition:.2s;
}

.status-btn:hover {
  background:#f5f5f5;
}

.status-btn.active.visited {
  border-color:#1976d2;
  background:#1976d2;
  color:#fff;
}

.status-btn.active.not-visited {
  border-color:#d32f2f;
  background:#d32f2f;
  color:#fff;
}

#comment-input {
  width:100%;
  min-height:100px;
  padding:10px;
  border:2px solid #ddd;
  border-radius:8px;
  font-size:14px;
  resize:vertical;
  box-sizing:border-box;
  font-family:inherit;
}

#char-count {
  text-align:right;
  font-size:12px;
  color:#666;
  margin-top:4px;
}

.modal-buttons {
  display:flex;
  gap:8px;
  margin-top:20px;
}

.modal-btn {
  flex:1;
  padding:12px;
  border:none;
  border-radius:8px;
  font-weight:bold;
  cursor:pointer;
  font-size:14px;
  transition:.2s;
}

.modal-btn.save {
  background:#4caf50;
  color:#fff;
}

.modal-btn.save:hover {
  background:#45a049;
}

.modal-btn.cancel {
  background:#f5f5f5;
  color:#333;
}

.modal-btn.cancel:hover {
  background:#e0e0e0;
}
</style>
</head>

<body>

<div id="progress">완료율 0%</div>
<div id="loading">저장 중...</div>
<div id="map"></div>

<!-- 모달 -->
<div id="modal">
  <div id="modal-content">
    <div id="modal-title"></div>
    
    <div class="modal-section">
      <label>방문 상태</label>
      <div class="status-buttons">
        <button class="status-btn not-visited" data-status="false">미방문</button>
        <button class="status-btn visited" data-status="true">방문완료</button>
      </div>
    </div>
    
    <div class="modal-section">
      <label>코멘트 (500자 이내)</label>
      <textarea id="comment-input" maxlength="500" placeholder="방문 후기나 메모를 입력하세요..."></textarea>
      <div id="char-count">0/500</div>
    </div>
    
    <div class="modal-buttons">
      <button class="modal-btn cancel">취소</button>
      <button class="modal-btn save">저장</button>
    </div>
  </div>
</div>

<script>
// ============================================
// Firebase 설정 (여기에 본인의 config를 입력하세요!)
// ============================================
const firebaseConfig = {
  apiKey: "AIzaSyDjTcHpGJskJNkY-qLlU02A_yDe4fCZIaI",
  authDomain: "store-map-5cf8b.firebaseapp.com",
  projectId: "store-map-5cf8b",
  storageBucket: "store-map-5cf8b.firebasestorage.app",
  messagingSenderId: "805186031186",
  appId: "1:805186031186:web:694602e04ee9579189998b"
};

// Firebase 초기화
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ============================================
// 매장 데이터
// ============================================
const stores = [
{num:1,name:"신도SDR",address:"서울 강남구 테헤란로88길 14"},
{num:2,name:"큰사랑대리점",address:"서울 강남구 언주로30길 21"},
{num:3,name:"한유대리점",address:"서울 강남구 광평로51길 8"},
{num:4,name:"새서울대리점",address:"서울 강남구 압구정로 154"},
{num:5,name:"강남스타대리점",address:"서울 강남구 선릉로 640"},
{num:6,name:"강남스타대리점",address:"서울 강남구 일원로 41"},
{num:7,name:"강남스타대리점",address:"서울 강남구 선릉로 640"},
{num:8,name:"라이즈",address:"서울 강남구 논현로154길 16"},
{num:9,name:"오아시스",address:"서울 강동구 천호옛길 70"},
{num:10,name:"준대리점",address:"서울 강동구 천호대로 1099"},
{num:11,name:"트렌드플래너",address:"서울 강동구 천호옛길 70"},
{num:12,name:"서울ent대리점",address:"서울 강동구 강동대로53길 31"},
{num:13,name:"서울ent대리점",address:"서울 강동구 강동대로53길 31"},
{num:14,name:"아리온",address:"서울 강동구 상암로 47"},
{num:15,name:"늘봄대리점",address:"서울 강동구 성내로 6"},
{num:16,name:"피앤씨홀딩스",address:"서울 강북구 삼양로 237"},
{num:17,name:"PS&M",address:"서울 강북구 도봉로 353"},
{num:18,name:"신나는",address:"서울 강서구 공항대로 168"},
{num:19,name:"참스타대리점",address:"서울 강서구 양천로 583"},
{num:20,name:"도일대리점",address:"서울 강서구 양천로 556"},
{num:21,name:"염창대리점",address:"서울 강서구 양천로 706"},
{num:22,name:"상록수대리점",address:"서울 강서구 강서로 254"},
{num:23,name:"상록수대리점",address:"서울 강서구 강서로 242"},
{num:24,name:"백두대간대리점",address:"서울 강서구 양천로 86"},
{num:25,name:"동진대리점",address:"서울 강서구 강서로 279"},
{num:26,name:"연우대리점",address:"서울 강서구 월정로 160"},
{num:27,name:"정원대리점",address:"서울 광진구 구의강변로 64"},
{num:28,name:"CD대리점",address:"서울 광진구 천호대로 597"},
{num:29,name:"광장대리점",address:"서울 광진구 면목로 160"},
{num:30,name:"울림터대리점",address:"서울 광진구 아차산로 220"},
{num:31,name:"알리바바대리점",address:"서울 광진구 천호대로143길 23"},
{num:32,name:"아토",address:"서울 광진구 천호대로 571"},
{num:33,name:"CD대리점",address:"서울 구로구 경인로 661"},
{num:34,name:"구로서부대리점",address:"서울 구로구 구로동로 82"},
{num:35,name:"PS&M",address:"서울 구로구 경인로 661"},
{num:36,name:"PS&M",address:"서울 구로구 도림로 73"},
{num:37,name:"독산대리점",address:"서울 금천구 시흥대로 233"},
{num:38,name:"어프레쉬대리점",address:"서울 금천구 시흥대로138길 19"},
{num:39,name:"지은대리점",address:"서울 금천구 벚꽃로 234"},
{num:40,name:"서울ent대리점",address:"서울 노원구 한글비석로 384"},
{num:41,name:"알파대리점",address:"서울 노원구 석계로 4"},
{num:42,name:"신창대리점",address:"서울 도봉구 덕릉로 248-1"},
{num:43,name:"서울신당대리점",address:"서울 동대문구 천호대로 14"},
{num:44,name:"707",address:"서울 마포구 월드컵로 62"},
{num:45,name:"울림터대리점",address:"서울 마포구 양화로 45"},
{num:46,name:"퓨처스",address:"서울 마포구 모래내로 5"},
{num:47,name:"논현역대리점",address:"서울 서초구 사평대로55길 149"},
{num:48,name:"미래대리점",address:"서울 성동구 마장로 284-1"},
{num:49,name:"한유대리점",address:"서울 성동구 아차산로 33"},
{num:50,name:"SK모바일포탈",address:"서울 성동구 아차산로 38"},
{num:51,name:"늘푸른대리점",address:"서울 성북구 동소문로 17"},
{num:52,name:"정릉대리점",address:"서울 성북구 보국문로 81"},
{num:53,name:"알파대리점",address:"서울 성북구 길음로 33"},
{num:54,name:"ACE대리점",address:"서울 성북구 화랑로 248"},
{num:55,name:"PS&M",address:"서울 성북구 아리랑로 10"},
{num:56,name:"브레인아이씨티",address:"서울 송파구 법원로11길 11"},
{num:57,name:"에스알",address:"서울 송파구 법원로8길 7"},
{num:58,name:"참스타대리점",address:"서울 양천구 남부순환로 585"},
{num:59,name:"한유대리점",address:"서울 양천구 목동동로 379"},
{num:60,name:"에스알",address:"서울 양천구 지양로 74"},
{num:61,name:"백두대간대리점",address:"서울 양천구 목동서로 349"},
{num:62,name:"서울ent대리점",address:"서울 영등포구 도영로 27"},
{num:63,name:"유통상가대리점",address:"서울 영등포구 영등포로 131"},
{num:64,name:"유원대리점",address:"서울 영등포구 선유로49길 23"},
{num:65,name:"새샘대리점",address:"서울 영등포구 당산로 83"},
{num:66,name:"펜타곤",address:"서울 용산구 한강대로7길 10-8"},
{num:67,name:"프리스비",address:"서울 용산구 한강대로 283-8"},
{num:68,name:"피앤씨홀딩스",address:"서울 용산구 이태원로 187"},
{num:69,name:"한유대리점",address:"서울 은평구 연서로 75"},
{num:70,name:"범교대리점",address:"서울 은평구 수색로 195"},
{num:71,name:"신드롬대리점",address:"서울 은평구 서오릉로 173"},
{num:72,name:"참스타대리점",address:"서울 종로구 송월길 99"},
{num:73,name:"유니쿱대리점",address:"서울 종로구 성균관로 15"},
{num:74,name:"유선대리점",address:"서울 중구 다산로 132"},
{num:75,name:"프리스비",address:"서울 중구 동호로 180"},
{num:76,name:"Orange",address:"서울 중구 명동3길 6"},
{num:77,name:"피앤씨홀딩스",address:"서울 중랑구 용마산로115길 127"},
{num:78,name:"PS&M",address:"서울 중랑구 동일로 801"}
];

let storeData = {};
let currentStore = null;
let map;

// ============================================
// Firebase 함수들
// ============================================

// Firestore에서 데이터 불러오기
async function loadDataFromFirebase() {
  try {
    const snapshot = await db.collection('stores').get();
    snapshot.forEach(doc => {
      storeData[doc.id] = doc.data();
    });
    console.log('Firebase에서 데이터 로드 완료:', Object.keys(storeData).length + '개');
    updateAllBubbles();
    updateProgress();
  } catch (error) {
    console.error('데이터 로드 실패:', error);
  }
}

// Firestore에 데이터 저장하기
async function saveDataToFirebase(storeNum, data) {
  showLoading(true);
  try {
    await db.collection('stores').doc(String(storeNum)).set(data);
    console.log(`매장 ${storeNum} 저장 완료`);
    showLoading(false);
  } catch (error) {
    console.error('저장 실패:', error);
    alert('저장에 실패했습니다. 다시 시도해주세요.');
    showLoading(false);
  }
}

// 로딩 표시
function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'block' : 'none';
}

// 모든 말풍선 업데이트
function updateAllBubbles() {
  Object.keys(storeData).forEach(num => {
    const bubble = document.getElementById(`b-${num}`);
    if (bubble && storeData[num].visited) {
      bubble.classList.add('visited');
    }
  });
}

// ============================================
// 기존 함수들
// ============================================

function updateProgress(){
  const total = stores.length;
  const done = Object.values(storeData).filter(v=>v.visited).length;
  const percent = Math.round((done/total)*100);
  document.getElementById("progress").innerText =
    `완료율 ${done}/${total} (${percent}%)`;
}

function openModal(storeNum){
  currentStore = storeNum;
  const store = stores.find(s => s.num === storeNum);
  const data = storeData[storeNum] || {visited: false, comment: ""};
  
  document.getElementById("modal-title").innerText = 
    `${store.num}. ${store.name}`;
  
  document.querySelectorAll(".status-btn").forEach(btn => {
    btn.classList.remove("active");
    if(btn.dataset.status === String(data.visited)){
      btn.classList.add("active");
    }
  });
  
  const textarea = document.getElementById("comment-input");
  textarea.value = data.comment || "";
  updateCharCount();
  
  document.getElementById("modal").classList.add("show");
}

function closeModal(){
  document.getElementById("modal").classList.remove("show");
  currentStore = null;
}

async function saveModal(){
  const visitedBtn = document.querySelector(".status-btn.active");
  const visited = visitedBtn ? visitedBtn.dataset.status === "true" : false;
  const comment = document.getElementById("comment-input").value;
  
  const data = {visited, comment, updatedAt: new Date().toISOString()};
  storeData[currentStore] = data;
  
  // Firebase에 저장
  await saveDataToFirebase(currentStore, data);
  
  // 말풍선 스타일 업데이트
  const bubble = document.getElementById(`b-${currentStore}`);
  if(visited){
    bubble.classList.add("visited");
  } else {
    bubble.classList.remove("visited");
  }
  
  updateProgress();
  closeModal();
}

function updateCharCount(){
  const textarea = document.getElementById("comment-input");
  const count = textarea.value.length;
  document.getElementById("char-count").innerText = `${count}/500`;
}

// 모달 이벤트
document.querySelector(".modal-btn.cancel").addEventListener("click", closeModal);
document.querySelector(".modal-btn.save").addEventListener("click", saveModal);
document.getElementById("comment-input").addEventListener("input", updateCharCount);

document.querySelectorAll(".status-btn").forEach(btn => {
  btn.addEventListener("click", function(){
    document.querySelectorAll(".status-btn").forEach(b => b.classList.remove("active"));
    this.classList.add("active");
  });
});

document.getElementById("modal").addEventListener("click", function(e){
  if(e.target === this){
    closeModal();
  }
});

// ============================================
// 지도 초기화
// ============================================

naver.maps.onJSContentLoaded = async function(){
  // Firebase에서 데이터 먼저 불러오기
  await loadDataFromFirebase();
  
  map = new naver.maps.Map("map", {
    center: new naver.maps.LatLng(37.55,126.97),
    zoom: 11
  });

  const bounds = new naver.maps.LatLngBounds();

  stores.forEach((store,index)=>{
    // 초기 데이터 설정 (Firebase에 없으면)
    if (!storeData[store.num]) {
      storeData[store.num] = {visited: false, comment: ""};
    }

    setTimeout(()=>{
      naver.maps.Service.geocode(
        {query:store.address},
        function(status,res){
          if(status !== naver.maps.Service.Status.OK) return;

          const addr = res.v2.addresses[0];
          const pos = new naver.maps.LatLng(addr.y, addr.x);
          bounds.extend(pos);

          const isVisited = storeData[store.num].visited ? 'visited' : '';

          const marker = new naver.maps.Marker({
            position: pos,
            map: map,
            icon:{
              content:`
                <div class="bubble ${isVisited}" id="b-${store.num}">
                  ${store.num}. ${store.name}
                </div>
              `,
              anchor: new naver.maps.Point(50,40)
            }
          });

          naver.maps.Event.addListener(marker,"click",()=>{
            openModal(store.num);
          });

          if(index === stores.length-1){
            map.fitBounds(bounds);
            updateProgress();
          }
        }
      );
    }, index*40);

  });
};
</script>

</body>
</html>

